# [逆伝播グラフ作成機能追加] 改修設計仕様書

## 1. 改修の目的・背景
- **背景**: [高階微分が使えず、手動で計算しななければならない状態を改善したいと考えたため]
- **目的**: [逆伝播で流れる値をVariableインスタンスに変更し、逆伝播時にグラフを生成するように修正する]

## 2. 変更内容一覧

| クラス名 | 関数/メソッド名 | 変更の概要 |
| :--- | :--- | :--- |
| `Variable` | `backward` | `self.grad`の値をVariableインスタンスに変更 |
| `Variable` | `backward` | `using_config`を使用しTrueの場合のみ勾配をbackwardに流す仕様に変更 |
| `Add`を除いた2項演算子関数 | `backward` | 逆伝播時に取り出す値をVariableインスタンスを取り出す仕様に変更 |

## 3. 詳細設計（Before & After）

### 3.1.1 [Variable]
#### 変更前 (Before)
- [`self.grad`に核のする値がndarrayになっていた]
- [`using_config`を使用せずグラフを作成しないまま逆伝播を行なっていた]
#### 変更後 (After)
- **引数**: backward呼び出し時に`using_config`に渡すフラグ`create_graph`を追加
- **データ構造**: `self.grad`に代入する値を`Variable`関数でラップする
- **抽出形式**: wile文の処理を`using_config`でTrueが渡された場合のみ行うように修正

### 3.1.2 追加変数一覧

| 追加先クラス名 | 追加先関数/メソッド名 | 関数名 | 役割 | 挿入箇所 |
| :--- | :--- | :--- | :--- |:--- |
| `Variable` | `backward` | `Variable` | `self.grad`をVariableインスタンスに変える | `self.grad = np.ones_like(self.data)` を`Variable`でラップ|
| `Variable` | `backward` | `using_config` | Trueが渡った場合のみbackawardを行うスイッチ | `gxs =  f.backward(*gys)`の直前にwith文を使い挿入 |

### 3.1.3 変更後処理フロー
1. インスタンス変数から勾配を取り出す際`self.grad = Variable(np.ones_like(self.data))`でVariableインスタンスとして取り出す
2. 以降heapqから世代順に関数を取り出すこと処理は変わらず
3. `with using_config('enabled_backprop', create_graph)`を用いることで以降の処理が`create_graph`の値がTrueの場合のみ実行される

### 3.2.1 [`Add`を除いた2項演算子関数]
#### 変更前 (Before)
- [`self.inputs`に格納されたndarrayを取り出していた]

#### 変更後 (After)
- **抽出形式**: `self.inputs[0].data`から`self.inputs`に変更し直接Variableインスタンスを取り出す

## 4. 影響範囲と整合性
- **関連1**: backwardで流れたデータがVariableインスタンスである必要がある。

## 5. テスト・検証項目
- [x] 変更後も正しく逆伝播を行えるか。