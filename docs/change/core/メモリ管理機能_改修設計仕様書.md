# [メモリ管理機能] 改修設計仕様書

## 1. 改修の目的・背景
- **背景**: [改善前は全ての変数で勾配を保持しており使用率の面でよろしくない状態と考えたため]
- **目的**: [メモリ管理の仕組みを導入しメモリ使用率を下げる]

## 2. 変更内容一覧

| クラス名 | 関数/メソッド名 | 変更の概要 |
| :--- | :--- | :--- |
| `Variable` | `backward` | 引数にflg（retain_grad=False）を追加、微分をNoneに書き換えるif文を追加 |
| `Function` | `__call__` | 世代ロジックにフラグ制御による切り替え機能を追加 |

## 3. 詳細設計（Before & After）

### 3.1 [Variable]
#### 変更前 (Before)
- [全ての変数が微分を保持する仕様になっていた]

#### 変更後 (After)
- **引数**: 制御用のflg `retain_grad=False` を追加。
- **書き換えロジック**: `retain_grad` がFalseの場合outputsのgradをNoneに書き換える。

### 3.2 [Function]
#### 変更前 (Before)
- [逆伝播の切り替えが行えず不必要なタイミングでも微分を保持していた]

#### 変更後 (After)
- **書き換えロジック**:  制御機能用 `if Config.enabled_backlop:` 世代の関係性を保持する前に追加。

## 4. 影響範囲と整合性
この改修によって修正が必要になる関連箇所。
- **関連1**: `Variable`クラスにretain_gradを使ったif文と書き換え処理を行うfor文を追加する必要がある。
- **関連2**: `backward`内におけるwhile文の末尾に処理の追記が必要となる。
- **関連3**: `Function`クラスでself.generationを設定する前に制御機能を追加する必要がある。

## 5. テスト・検証項目
改修が正しく行われたかをどう確認するか。
- [x] 途中経過の微分がNoneに書き換えられているか。 
- [] フラグをTrueにした場合に逆伝播を行わないか。